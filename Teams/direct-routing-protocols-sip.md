---
title: Enrutamiento directo del sistema telefónico
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Protocolos de enrutamiento directo
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899131"
---
# <a name="direct-routing---sip-protocol"></a><span data-ttu-id="90c5b-103">Enrutamiento directo: protocolo SIP</span><span class="sxs-lookup"><span data-stu-id="90c5b-103">Direct Routing - SIP protocol</span></span>

<span data-ttu-id="90c5b-104">En este artículo se describe cómo enrutamiento directo implementa el Protocolo de inicio de sesión (SIP).</span><span class="sxs-lookup"><span data-stu-id="90c5b-104">This article describes how Direct Routing implements the Session Initiation Protocol (SIP).</span></span> <span data-ttu-id="90c5b-105">Para enrutar correctamente el tráfico entre un controlador de borde de sesión (SBC) y el proxy SIP, algunos parámetros SIP deben tener valores específicos.</span><span class="sxs-lookup"><span data-stu-id="90c5b-105">To properly route traffic between a Session Border Controller (SBC) and the SIP proxy, some SIP parameters must have specific values.</span></span> <span data-ttu-id="90c5b-106">Este artículo está destinado a los administradores de voz responsables de configurar la conexión entre el SBC local y el servicio de proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-106">This article is intended for voice administrators who are responsible for configuring the connection between the on-premises SBC and the SIP proxy service.</span></span>

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a><span data-ttu-id="90c5b-107">Procesar la solicitud entrante: buscar el inquilino y el usuario</span><span class="sxs-lookup"><span data-stu-id="90c5b-107">Processing the incoming request: finding the tenant and user</span></span>

<span data-ttu-id="90c5b-108">Antes de que se pueda procesar una llamada entrante o saliente, los mensajes OPTIONS se intercambian entre el proxy SIP y el SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-108">Before an incoming or outbound call can be processed, OPTIONS messages are exchanged between SIP Proxy and the SBC.</span></span> <span data-ttu-id="90c5b-109">Estos mensajes OPTIONS permiten que el proxy SIP proporcione las capacidades permitidas a SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-109">These OPTIONS messages allow SIP Proxy to provide the allowed capabilities to SBC.</span></span> <span data-ttu-id="90c5b-110">Es importante que la negociación DE OPCIONES tenga éxito (respuesta 200OK), lo que permite una mayor comunicación entre SBC y proxy SIP para establecer llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-110">It is important for OPTIONS negotiation to be successful (200OK response), allowing for further communication between SBC and SIP Proxy for establishing calls.</span></span> <span data-ttu-id="90c5b-111">Los encabezados SIP de un mensaje OPTIONS para proxy SIP se proporcionan como ejemplo a continuación:</span><span class="sxs-lookup"><span data-stu-id="90c5b-111">The SIP headers in an OPTIONS messages to SIP Proxy are provided as an example below:</span></span>

| <span data-ttu-id="90c5b-112">Nombre del parámetro</span><span class="sxs-lookup"><span data-stu-id="90c5b-112">Parameter name</span></span> | <span data-ttu-id="90c5b-113">Ejemplo del valor</span><span class="sxs-lookup"><span data-stu-id="90c5b-113">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="90c5b-114">Request-URI</span><span class="sxs-lookup"><span data-stu-id="90c5b-114">Request-URI</span></span> | <span data-ttu-id="90c5b-115">OPCIONES sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="90c5b-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span></span> |
| <span data-ttu-id="90c5b-116">A través del encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-116">Via Header</span></span> | <span data-ttu-id="90c5b-117">A través de: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="90c5b-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="90c5b-118">Max-Forwards encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-118">Max-Forwards header</span></span> | <span data-ttu-id="90c5b-119">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="90c5b-119">Max-Forwards:68</span></span> |
| <span data-ttu-id="90c5b-120">Desde encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-120">From Header</span></span> | <span data-ttu-id="90c5b-121">Desde el encabezado desde: <sip:sbc1.adatum.biz:5058></span><span class="sxs-lookup"><span data-stu-id="90c5b-121">From Header From: <sip:sbc1.adatum.biz:5058></span></span> |
| <span data-ttu-id="90c5b-122">A Encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-122">To Header</span></span> | <span data-ttu-id="90c5b-123">Para: <sip:sip.pstnhub.microsoft.com:5061></span><span class="sxs-lookup"><span data-stu-id="90c5b-123">To: <sip:sip.pstnhub.microsoft.com:5061></span></span> |
| <span data-ttu-id="90c5b-124">Encabezado CSeq</span><span class="sxs-lookup"><span data-stu-id="90c5b-124">CSeq header</span></span> | <span data-ttu-id="90c5b-125">CSeq: 1 INVITACIÓN</span><span class="sxs-lookup"><span data-stu-id="90c5b-125">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="90c5b-126">Encabezado de contacto</span><span class="sxs-lookup"><span data-stu-id="90c5b-126">Contact Header</span></span> | <span data-ttu-id="90c5b-127">Contacto: <sip:sbc1.adatum.biz:50588;transport=tls></span><span class="sxs-lookup"><span data-stu-id="90c5b-127">Contact: <sip:sbc1.adatum.biz:50588;transport=tls></span></span> |

> [!NOTE]
> <span data-ttu-id="90c5b-128">Los encabezados SIP no contienen userinfo en el URI de SIP en uso.</span><span class="sxs-lookup"><span data-stu-id="90c5b-128">The SIP headers do not contain userinfo in the SIP URI in use.</span></span> <span data-ttu-id="90c5b-129">Según [RFC 3261, sección 19.1.1,](https://tools.ietf.org/html/rfc3261#section-19.1.1)la parte userinfo de un URI es opcional y puede estar ausente cuando el host de destino no tiene un concepto de usuarios o cuando el propio recurso está identificado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-129">As per [RFC 3261, section 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), the userinfo part of a URI is optional and MAY be absent when the destination host does not have a notion of users or when the hosst itself is the resource being identified.</span></span> <span data-ttu-id="90c5b-130">Si el signo @ está presente en un URI SIP, el campo de usuario NO DEBE estar vacío.</span><span class="sxs-lookup"><span data-stu-id="90c5b-130">If the @ sign is present in a SIP URI, the user field MUST NOT be empty.</span></span>

<span data-ttu-id="90c5b-131">En una llamada entrante, el proxy SIP debe buscar el espacio empresarial al que está destinada la llamada y encontrar el usuario específico dentro de este espacio empresarial.</span><span class="sxs-lookup"><span data-stu-id="90c5b-131">On an incoming call, the SIP proxy needs to find the tenant to which the call is destined and find the specific user within this tenant.</span></span> <span data-ttu-id="90c5b-132">El administrador de inquilinos puede configurar números que no son DID, por ejemplo +1001, en varios inquilinos.</span><span class="sxs-lookup"><span data-stu-id="90c5b-132">The tenant administrator might configure non-DID numbers, for example +1001, in multiple tenants.</span></span> <span data-ttu-id="90c5b-133">Por lo tanto, es importante buscar el espacio empresarial específico en el que realizar la búsqueda de números porque los números que no son DID pueden ser los mismos en varias organizaciones de Microsoft 365 u Office 365.</span><span class="sxs-lookup"><span data-stu-id="90c5b-133">Therefore, it is important to find the specific tenant on which to perform the number lookup because the non-DID numbers might be the same in multiple Microsoft 365 or Office 365 organizations.</span></span>  

<span data-ttu-id="90c5b-134">En esta sección se describe cómo el proxy SIP encuentra el inquilino y el usuario, y realiza la autenticación del SBC en la conexión entrante.</span><span class="sxs-lookup"><span data-stu-id="90c5b-134">This section describes how the SIP proxy finds the tenant and the user, and performs authentication of the SBC on the incoming connection.</span></span>

<span data-ttu-id="90c5b-135">A continuación se muestra un ejemplo del mensaje Invitar SIP en una llamada entrante:</span><span class="sxs-lookup"><span data-stu-id="90c5b-135">The following is an example of the SIP Invite message on an incoming call:</span></span>

| <span data-ttu-id="90c5b-136">Nombre del parámetro</span><span class="sxs-lookup"><span data-stu-id="90c5b-136">Parameter name</span></span> | <span data-ttu-id="90c5b-137">Ejemplo del valor</span><span class="sxs-lookup"><span data-stu-id="90c5b-137">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="90c5b-138">Request-URI</span><span class="sxs-lookup"><span data-stu-id="90c5b-138">Request-URI</span></span> | <span data-ttu-id="90c5b-139">INVITAR sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="90c5b-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span></span> |
| <span data-ttu-id="90c5b-140">A través del encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-140">Via Header</span></span> | <span data-ttu-id="90c5b-141">A través de: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="90c5b-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="90c5b-142">Max-Forwards encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-142">Max-Forwards header</span></span> | <span data-ttu-id="90c5b-143">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="90c5b-143">Max-Forwards:68</span></span> |
| <span data-ttu-id="90c5b-144">Desde encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-144">From Header</span></span> | <span data-ttu-id="90c5b-145">Del encabezado de: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span><span class="sxs-lookup"><span data-stu-id="90c5b-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span></span> |
| <span data-ttu-id="90c5b-146">A Encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-146">To Header</span></span> | <span data-ttu-id="90c5b-147">Para: sip:+183338006777@sbc1.adatum.biz</span><span class="sxs-lookup"><span data-stu-id="90c5b-147">To: sip:+183338006777@sbc1.adatum.biz</span></span> | 
| <span data-ttu-id="90c5b-148">Encabezado CSeq</span><span class="sxs-lookup"><span data-stu-id="90c5b-148">CSeq header</span></span> | <span data-ttu-id="90c5b-149">CSeq: 1 INVITACIÓN</span><span class="sxs-lookup"><span data-stu-id="90c5b-149">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="90c5b-150">Encabezado de contacto</span><span class="sxs-lookup"><span data-stu-id="90c5b-150">Contact Header</span></span> | <span data-ttu-id="90c5b-151">Contacto: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span><span class="sxs-lookup"><span data-stu-id="90c5b-151">Contact: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span></span> | 

<span data-ttu-id="90c5b-152">Al recibir la invitación, el proxy SIP realiza los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="90c5b-152">On receiving the invite, the SIP proxy performs the following steps:</span></span>

1. <span data-ttu-id="90c5b-153">Compruebe el certificado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-153">Check the certificate.</span></span> <span data-ttu-id="90c5b-154">En la conexión inicial, el servicio enrutamiento directo toma el nombre FQDN que se muestra en el encabezado contacto y lo hace con el nombre común o el nombre alternativo del asunto del certificado presentado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-154">On the initial connection, the Direct Routing service takes the FQDN name presented in the Contact header and matches it to the Common Name or Subject Alternative name of the presented certificate.</span></span> <span data-ttu-id="90c5b-155">El nombre de SBC debe coincidir con una de las siguientes opciones:</span><span class="sxs-lookup"><span data-stu-id="90c5b-155">The SBC name must match one of the following options:</span></span>

   - <span data-ttu-id="90c5b-156">Opción 1.</span><span class="sxs-lookup"><span data-stu-id="90c5b-156">Option 1.</span></span> <span data-ttu-id="90c5b-157">El nombre completo fqdn que se presenta en el encabezado de contacto debe coincidir con el nombre común o el nombre alternativo del asunto del certificado presentado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-157">The full FQDN name presented in the Contact header must match the Common Name/Subject Alternative name of the presented certificate.</span></span>  

   - <span data-ttu-id="90c5b-158">Opción 2.</span><span class="sxs-lookup"><span data-stu-id="90c5b-158">Option 2.</span></span> <span data-ttu-id="90c5b-159">La parte de dominio del nombre FQDN que se presenta en el encabezado Contacto (por ejemplo, adatum.biz del nombre FQDN sbc1.adatum.biz) debe coincidir con el valor comodín en Nombre común/Nombre alternativo del asunto (por ejemplo, \*.adatum.biz).</span><span class="sxs-lookup"><span data-stu-id="90c5b-159">The domain portion of the FQDN name presented in the Contact header (for example adatum.biz of the FQDN name sbc1.adatum.biz) must match the wildcard value in Common Name/Subject Alternative Name (for example \*.adatum.biz).</span></span>

2. <span data-ttu-id="90c5b-160">Intente buscar un inquilino con el nombre completo fqdn que se muestra en el encabezado Contacto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-160">Try to find a tenant using the full FQDN name presented in the Contact header.</span></span>  

   <span data-ttu-id="90c5b-161">Compruebe si el nombre FQDN del encabezado de contacto (sbc1.adatum.biz) está registrado como nombre DNS en cualquier organización de Microsoft 365 u Office 365.</span><span class="sxs-lookup"><span data-stu-id="90c5b-161">Check if the FQDN name from the Contact header (sbc1.adatum.biz) is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="90c5b-162">Si se encuentra, la búsqueda del usuario se realiza en el espacio empresarial que tiene el FQDN de SBC registrado como nombre de dominio.</span><span class="sxs-lookup"><span data-stu-id="90c5b-162">If found, the lookup of the user is performed in the tenant that has the SBC FQDN registered as a Domain name.</span></span> <span data-ttu-id="90c5b-163">Si no se encuentra, se aplica el paso 3.</span><span class="sxs-lookup"><span data-stu-id="90c5b-163">If not found, Step 3 applies.</span></span>   

3. <span data-ttu-id="90c5b-164">El paso 3 solo se aplica si se ha fallado el paso 2.</span><span class="sxs-lookup"><span data-stu-id="90c5b-164">Step 3 only applies if Step 2 failed.</span></span> 

   <span data-ttu-id="90c5b-165">Quite la parte del host del FQDN, que se muestra en el encabezado De contacto (FQDN: sbc12.adatum.biz, después de quitar la parte del host: adatum.biz) y compruebe si este nombre está registrado como nombre DNS en cualquier organización de Microsoft 365 u Office 365.</span><span class="sxs-lookup"><span data-stu-id="90c5b-165">Remove the host portion from the FQDN, presented in the Contact header (FQDN: sbc12.adatum.biz, after removing the host portion: adatum.biz), and check if this name is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="90c5b-166">Si se encuentra, la búsqueda de usuario se realiza en este espacio empresarial.</span><span class="sxs-lookup"><span data-stu-id="90c5b-166">If found, the user lookup is performed in this tenant.</span></span> <span data-ttu-id="90c5b-167">Si no se encuentra, se produce un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-167">If not found, the call fails.</span></span>

4. <span data-ttu-id="90c5b-168">Con el número de teléfono presentado en el URI de solicitud, realice la búsqueda de número inverso dentro del espacio empresarial que se encuentra en los pasos 2 o 3.</span><span class="sxs-lookup"><span data-stu-id="90c5b-168">Using the phone number presented in the Request-URI, perform the reverse number lookup within the tenant found in Step 2 or 3.</span></span> <span data-ttu-id="90c5b-169">Coincida con el número de teléfono presentado con un URI SIP de usuario dentro del espacio empresarial encontrado en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="90c5b-169">Match the presented phone number to a user SIP URI within the tenant found on the previous step.</span></span>

5. <span data-ttu-id="90c5b-170">Aplicar la configuración del tronco.</span><span class="sxs-lookup"><span data-stu-id="90c5b-170">Apply trunk settings.</span></span> <span data-ttu-id="90c5b-171">Busque los parámetros establecidos por el administrador de inquilinos para este SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-171">Find the parameters set by the tenant admin for this SBC.</span></span>

   <span data-ttu-id="90c5b-172">Microsoft no admite tener un proxy SIP de terceros o un servidor de agente de usuario entre el proxy SIP de Microsoft y el SBC emparejado, lo que podría modificar el URI de solicitud creado por el SBC emparejado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-172">Microsoft does not support having a third-party SIP proxy or User Agent Server between the Microsoft SIP proxy and the paired SBC, which might modify the Request URI created by the paired SBC.</span></span>

   <span data-ttu-id="90c5b-173">Los requisitos para las dos búsquedas (pasos 2 y 3) necesarios para el escenario en el que un SBC está interconectado con muchos inquilinos (escenario de operador) se tratan más adelante en este artículo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-173">The requirements for the two lookups (steps 2 and 3) needed for the scenario where one SBC is interconnected to many tenants (carrier scenario) are covered later in this article.</span></span>

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a><span data-ttu-id="90c5b-174">Requisitos detallados para encabezado de contacto y Solicitud-URI</span><span class="sxs-lookup"><span data-stu-id="90c5b-174">Detailed requirements for Contact header and Request-URI</span></span>

#### <a name="contact-header"></a><span data-ttu-id="90c5b-175">Encabezado de contacto</span><span class="sxs-lookup"><span data-stu-id="90c5b-175">Contact header</span></span>

<span data-ttu-id="90c5b-176">Para todos los mensajes SIP entrantes (OPCIONES, INVITAR) al proxy SIP de Microsoft, el encabezado de contacto debe tener el FQDN de SBC emparejado en el nombre de host uri como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="90c5b-176">For all incoming SIP messages (OPTIONS, INVITE) to the Microsoft SIP proxy, the Contact header must have the paired SBC FQDN in the URI hostname as follows:</span></span>

<span data-ttu-id="90c5b-177">Sintaxis: Contacto: <sip:phone o sip address@FQDN del SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="90c5b-177">Syntax: Contact:  <sip:phone or sip address@FQDN of the SBC;transport=tls></span></span> 

<span data-ttu-id="90c5b-178">Según [RFC 3261, sección 11.1,](https://tools.ietf.org/html/rfc3261#section-11.1)un campo de encabezado de contacto puede estar presente en un mensaje OPTIONS.</span><span class="sxs-lookup"><span data-stu-id="90c5b-178">As per [RFC 3261, section 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), a Contact header field MAY be present in an OPTIONS message.</span></span> <span data-ttu-id="90c5b-179">En Enrutamiento directo, el encabezado de contacto es obligatorio.</span><span class="sxs-lookup"><span data-stu-id="90c5b-179">In Direct Routing the contact header is required.</span></span> <span data-ttu-id="90c5b-180">Para los mensajes INVITE en formato anterior, para los mensajes OPTIONS, el userinfo se puede quitar del URI de SIP y solo el FQDN enviado en formato como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="90c5b-180">For INVITE messages in format above, for OPTIONS messages the userinfo can be removed from SIP URI and only FQDN sent in format as follows:</span></span>

<span data-ttu-id="90c5b-181">Sintaxis: Contacto: <sip:FQDN del SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="90c5b-181">Syntax: Contact:  <sip:FQDN of the SBC;transport=tls></span></span>

<span data-ttu-id="90c5b-182">Este nombre (FQDN) también debe estar en los campos Nombre común o Nombre alternativo del asunto del certificado presentado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-182">This name (FQDN) must also be in the Common Name or Subject Alternative name field(s) of the presented certificate.</span></span> <span data-ttu-id="90c5b-183">Microsoft admite el uso de valores comodín de los nombres en los campos Nombre común o Nombre alternativo del asunto del certificado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-183">Microsoft supports using wildcard values of the name(s) in the Common Name or Subject Alternative Name fields of the certificate.</span></span>   

<span data-ttu-id="90c5b-184">La compatibilidad con caracteres comodín se describe [en RFC 2818, sección 3.1.](https://tools.ietf.org/html/rfc2818#section-3.1)</span><span class="sxs-lookup"><span data-stu-id="90c5b-184">The support for wildcards is described in [RFC 2818, section 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span></span> <span data-ttu-id="90c5b-185">Específicamente:</span><span class="sxs-lookup"><span data-stu-id="90c5b-185">Specifically:</span></span>

<span data-ttu-id="90c5b-186">*"Los nombres pueden contener el carácter comodín que se considera que coincide con cualquier único componente de nombre de dominio \* o fragmento de componente. Por ejemplo, .a.com coincide foo.a.com pero no bar.foo.a.com. f .com coincide foo.com \* \* pero no bar.com".*</span><span class="sxs-lookup"><span data-stu-id="90c5b-186">*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. E.g., \*.a.com matches foo.a.com but not bar.foo.a.com. f\*.com matches foo.com but not bar.com."*</span></span>

<span data-ttu-id="90c5b-187">Si el SBC envía más de un valor en el encabezado Contacto presentado en un mensaje SIP, solo se usa la parte FQDN del primer valor del encabezado de contacto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-187">If more than one value in the Contact header presented in a SIP message is sent by the SBC, only the FQDN portion of the first value of the Contact header is used.</span></span>

<span data-ttu-id="90c5b-188">Como regla general para enrutamiento directo, es importante que el FQDN se utilice para rellenar URI DE SIP en lugar de IP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-188">As rule of thumb for Direct Routing, it is important that FQDN is used to populate SIP URI instead of IP.</span></span> <span data-ttu-id="90c5b-189">Un mensaje DE INVITACIÓN o OPCIONES entrante a Proxy SIP con encabezado de contacto en el que el nombre de host se representa mediante IP y no FQDN, la conexión se rechazará con 403 Prohibido.</span><span class="sxs-lookup"><span data-stu-id="90c5b-189">An incoming INVITE or OPTIONS message to SIP Proxy with Contact header where hostname is represented by IP and not FQDN, the connection will be refused with 403 Forbidden.</span></span>

#### <a name="request-uri"></a><span data-ttu-id="90c5b-190">Request-URI</span><span class="sxs-lookup"><span data-stu-id="90c5b-190">Request-URI</span></span> 

<span data-ttu-id="90c5b-191">Para todas las llamadas entrantes, el URI de solicitud se usa para hacer coincidir el número de teléfono con un usuario.</span><span class="sxs-lookup"><span data-stu-id="90c5b-191">For all incoming calls, the Request-URI is used to match the phone number to a user.</span></span>   

<span data-ttu-id="90c5b-192">Actualmente, el número de teléfono debe contener un signo más (+) como se muestra en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="90c5b-192">Currently The phone number must contain a plus sign (+) as shown in the following example.</span></span> 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a><span data-ttu-id="90c5b-193">Consideraciones de Record-Route de contacto y encabezados</span><span class="sxs-lookup"><span data-stu-id="90c5b-193">Contact and Record-Route headers considerations</span></span>

<span data-ttu-id="90c5b-194">El proxy SIP necesita calcular el FQDN de salto siguiente para las nuevas transacciones de cliente en el cuadro de diálogo (por ejemplo, Bye o Re-Invite) y al responder a Opciones SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-194">The SIP proxy needs to calculate the next hop FQDN for new in-dialog client transactions (for example Bye or Re-Invite), and when replying to SIP Options.</span></span> <span data-ttu-id="90c5b-195">Se usan las Record-Route contacto o las Record-Route.</span><span class="sxs-lookup"><span data-stu-id="90c5b-195">Either Contact or Record-Route are used.</span></span> 

<span data-ttu-id="90c5b-196">Según [RFC 3261, sección 8.1.1.8,](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)el encabezado de contacto es necesario en cualquier solicitud que pueda dar como resultado un nuevo cuadro de diálogo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-196">According to [RFC 3261, section 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), Contact header is required in any request that can result in a new dialog.</span></span> <span data-ttu-id="90c5b-197">El Record-Route solo es necesario si un proxy desea mantenerse en la ruta de acceso de las solicitudes futuras en un cuadro de diálogo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-197">The Record-Route is only required if a proxy wants to stay on the path of future requests in a dialog.</span></span> <span data-ttu-id="90c5b-198">Si un SBC proxy está en uso con optimización de medios [locales](./direct-routing-media-optimization.md)para enrutamiento directo, deberá configurarse una ruta de registro ya que el SBC proxy debe permanecer en la ruta.</span><span class="sxs-lookup"><span data-stu-id="90c5b-198">If a proxy SBC is in use with [Local Media Optimization for Direct Routing](./direct-routing-media-optimization.md), a record route will need to be configured as the proxy SBC needs to stay in the route.</span></span> 

<span data-ttu-id="90c5b-199">Microsoft recomienda usar solo el encabezado de contacto si no se usa un SBC proxy:</span><span class="sxs-lookup"><span data-stu-id="90c5b-199">Microsoft recommends using only Contact header if a proxy SBC is not used:</span></span>

- <span data-ttu-id="90c5b-200">Por [RFC 3261, sección 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route se usa si un proxy quiere mantenerse en la ruta de las solicitudes futuras en un cuadro de diálogo, lo que no es esencial si no se configura ningún SBC proxy ya que todo el tráfico va entre el proxy SIP de Microsoft y el SBC emparejado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-200">Per [RFC 3261, section 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route is used if a proxy wants to stay on the path of future requests in a dialog, which is not essential if no proxy SBC is configured as all traffic goes between the Microsoft SIP proxy and the paired SBC.</span></span> 

- <span data-ttu-id="90c5b-201">El proxy SIP de Microsoft usa solo encabezado de contacto (no Ruta de registro) para determinar el siguiente salto al enviar opciones de ping salientes.</span><span class="sxs-lookup"><span data-stu-id="90c5b-201">The Microsoft SIP proxy uses only Contact header (not Record-Route) to determine the next hop when sending outbound ping Options.</span></span> <span data-ttu-id="90c5b-202">Configurar solo un parámetro (Contacto) en lugar de dos (Contacto y Ruta de registro) simplifica la administración si no se usa un SBC proxy.</span><span class="sxs-lookup"><span data-stu-id="90c5b-202">Configuring only one parameter (Contact) instead of two (Contact and Record-Route) simplifies the administration if a proxy SBC is not in use.</span></span> 

<span data-ttu-id="90c5b-203">Para calcular el salto siguiente, el proxy SIP usa:</span><span class="sxs-lookup"><span data-stu-id="90c5b-203">To calculate the next hop, the SIP proxy uses:</span></span>

- <span data-ttu-id="90c5b-204">Prioridad 1.</span><span class="sxs-lookup"><span data-stu-id="90c5b-204">Priority 1.</span></span> <span data-ttu-id="90c5b-205">Ruta de registro de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="90c5b-205">Top-level Record-Route.</span></span> <span data-ttu-id="90c5b-206">Si el nombre de Record-Route nivel superior contiene el nombre FQDN, el nombre FQDN se usa para realizar la conexión saliente en el cuadro de diálogo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-206">If the top-level Record-Route contains the FQDN name, the FQDN name is used to make the outbound in-dialog connection.</span></span>

- <span data-ttu-id="90c5b-207">Prioridad 2.</span><span class="sxs-lookup"><span data-stu-id="90c5b-207">Priority 2.</span></span> <span data-ttu-id="90c5b-208">Encabezado de contacto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-208">Contact header.</span></span> <span data-ttu-id="90c5b-209">Si Record-Route no existe, el proxy SIP buscará el valor del encabezado Contacto para realizar la conexión saliente.</span><span class="sxs-lookup"><span data-stu-id="90c5b-209">If Record-Route does not exist, the SIP proxy will look up the value of the Contact header to make the outbound connection.</span></span> <span data-ttu-id="90c5b-210">(Esta es la configuración recomendada).</span><span class="sxs-lookup"><span data-stu-id="90c5b-210">(This is the recommended configuration.)</span></span>

<span data-ttu-id="90c5b-211">Si se usan contact y Record-Route, el administrador de SBC debe mantener sus valores idénticos, lo que causa sobrecarga administrativa.</span><span class="sxs-lookup"><span data-stu-id="90c5b-211">If both Contact and Record-Route are used, the SBC administrator must keep their values identical, which causes administrative overhead.</span></span> 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a><span data-ttu-id="90c5b-212">Uso del nombre FQDN en Contacto o Record-Route</span><span class="sxs-lookup"><span data-stu-id="90c5b-212">Use of FQDN name in Contact or Record-Route</span></span>

<span data-ttu-id="90c5b-213">El uso de una dirección IP no es compatible ni en Record-Route ni en Contacto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-213">Use of an IP address is not supported in either Record-Route or Contact.</span></span> <span data-ttu-id="90c5b-214">La única opción compatible es un FQDN, que debe coincidir con el nombre común o el nombre alternativo del asunto del certificado SBC (se admiten valores comodín en el certificado).</span><span class="sxs-lookup"><span data-stu-id="90c5b-214">The only supported option is an FQDN, which must match either the Common Name or Subject Alternative Name of the SBC certificate (wildcard values in the certificate are supported).</span></span>

- <span data-ttu-id="90c5b-215">Si se presenta una dirección IP en Ruta de registro o Contacto, se produce un error en la comprobación del certificado y se produce un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-215">If an IP address is presented in Record-route or Contact, the certificate check fails and the call fails.</span></span>

- <span data-ttu-id="90c5b-216">Si el FQDN no coincide con el valor del nombre alternativo común o del asunto en el certificado presentado, se produce un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-216">If the FQDN does not match the value of the Common or Subject Alternative Name in the presented certificate, the call fails.</span></span> 

## <a name="inbound-call-sip-dialog-description"></a><span data-ttu-id="90c5b-217">Llamada entrante: descripción del cuadro de diálogo SIP</span><span class="sxs-lookup"><span data-stu-id="90c5b-217">Inbound call: SIP dialog description</span></span>

<span data-ttu-id="90c5b-218">En la siguiente tabla se resumen las diferencias y similitudes de flujo de llamada entre los modos de no omisión y omisión:</span><span class="sxs-lookup"><span data-stu-id="90c5b-218">The following table below summarizes the call flow differences and similarities between non-bypass and bypass modes:</span></span>

| <span data-ttu-id="90c5b-219">Nombre del parámetro</span><span class="sxs-lookup"><span data-stu-id="90c5b-219">Parameter name</span></span> | <span data-ttu-id="90c5b-220">Modo sin omisión</span><span class="sxs-lookup"><span data-stu-id="90c5b-220">Non-bypass mode</span></span> | <span data-ttu-id="90c5b-221">Modo de omisión</span><span class="sxs-lookup"><span data-stu-id="90c5b-221">Bypass mode</span></span>
| :---------------------  |:---------------------- |:----------------|
| <span data-ttu-id="90c5b-222">Candidatos multimedia en 183 y 200 mensajes procedentes de</span><span class="sxs-lookup"><span data-stu-id="90c5b-222">Media candidates in 183 and 200 messages coming from</span></span> | <span data-ttu-id="90c5b-223">Procesadores multimedia</span><span class="sxs-lookup"><span data-stu-id="90c5b-223">Media processors</span></span> | <span data-ttu-id="90c5b-224">Clientes</span><span class="sxs-lookup"><span data-stu-id="90c5b-224">Clients</span></span> | 
| <span data-ttu-id="90c5b-225">Número de 183 mensajes que SBC puede recibir</span><span class="sxs-lookup"><span data-stu-id="90c5b-225">Number of 183 messages SBC can receive</span></span> | <span data-ttu-id="90c5b-226">Uno por sesión</span><span class="sxs-lookup"><span data-stu-id="90c5b-226">One per session</span></span> | <span data-ttu-id="90c5b-227">Múltiplo</span><span class="sxs-lookup"><span data-stu-id="90c5b-227">Multiple</span></span> | 
| <span data-ttu-id="90c5b-228">La llamada puede ser con respuesta provisional (183)</span><span class="sxs-lookup"><span data-stu-id="90c5b-228">Call can be with provisional answer (183)</span></span> | <span data-ttu-id="90c5b-229">Sí</span><span class="sxs-lookup"><span data-stu-id="90c5b-229">Yes</span></span> | <span data-ttu-id="90c5b-230">Sí</span><span class="sxs-lookup"><span data-stu-id="90c5b-230">Yes</span></span> |
| <span data-ttu-id="90c5b-231">La llamada puede no tener respuesta provisional (183)</span><span class="sxs-lookup"><span data-stu-id="90c5b-231">Call can be without provisional answer (183)</span></span> | <span data-ttu-id="90c5b-232">Sí</span><span class="sxs-lookup"><span data-stu-id="90c5b-232">Yes</span></span> | <span data-ttu-id="90c5b-233">Sí</span><span class="sxs-lookup"><span data-stu-id="90c5b-233">Yes</span></span> |

###  <a name="non-media-bypass-flow"></a><span data-ttu-id="90c5b-234">Flujo de omisión no multimedia</span><span class="sxs-lookup"><span data-stu-id="90c5b-234">Non-media bypass flow</span></span>

<span data-ttu-id="90c5b-235">Un usuario de Teams puede tener varios puntos de conexión al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-235">A Teams user might have multiple endpoints at the same time.</span></span> <span data-ttu-id="90c5b-236">Por ejemplo, cliente de Teams para Windows, cliente de Teams para iPhone y Teams Phone (cliente Android de Teams).</span><span class="sxs-lookup"><span data-stu-id="90c5b-236">For example, Teams for Windows client, Teams for iPhone client, and Teams Phone (Teams Android client).</span></span> <span data-ttu-id="90c5b-237">Cada punto de conexión puede indicar un reposo HTTP de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="90c5b-237">Each endpoint might signal an HTTP rest as follows:</span></span>

-   <span data-ttu-id="90c5b-238">Progreso de la llamada: convertido por el proxy SIP al mensaje SIP 180.</span><span class="sxs-lookup"><span data-stu-id="90c5b-238">Call progress – converted by the SIP proxy to the SIP message 180.</span></span> <span data-ttu-id="90c5b-239">Al recibir el mensaje 180, el SBC debe generar una llamada local.</span><span class="sxs-lookup"><span data-stu-id="90c5b-239">On receiving message 180, the SBC must generate local ringing.</span></span>

-   <span data-ttu-id="90c5b-240">Respuesta multimedia: convertida por el proxy SIP en el mensaje 183 con candidatos multimedia en el Protocolo de descripción de sesión (SDP).</span><span class="sxs-lookup"><span data-stu-id="90c5b-240">Media answer – converted by the SIP proxy to message 183 with media candidates in Session Description Protocol (SDP).</span></span> <span data-ttu-id="90c5b-241">Al recibir el mensaje 183, el SBC espera conectarse a los candidatos multimedia recibidos en el mensaje SDP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-241">On receiving message 183, the SBC expects to connect to the media candidates received in the SDP message.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="90c5b-242">En algunos casos, es posible que no se genere la respuesta multimedia y que el punto final responda con el mensaje "Llamada aceptada".</span><span class="sxs-lookup"><span data-stu-id="90c5b-242">In some cases the Media answer might not be generated, and the end point might answer with “Call Accepted” message.</span></span>

-   <span data-ttu-id="90c5b-243">Llamada aceptada: convertida por el proxy SIP en el mensaje SIP 200 con SDP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-243">Call accepted – converted by the SIP proxy to SIP message 200 with SDP.</span></span> <span data-ttu-id="90c5b-244">Al recibir el mensaje 200, se espera que el SBC envíe y reciba los medios a y desde los candidatos del SDP proporcionados.</span><span class="sxs-lookup"><span data-stu-id="90c5b-244">On receiving message 200, the SBC is expected to send and receive media to and from the provided SDP candidates.</span></span>

    > [!NOTE]
    > <span data-ttu-id="90c5b-245">El enrutamiento directo no admite la invitación de oferta retrasada (invitación sin SDP).</span><span class="sxs-lookup"><span data-stu-id="90c5b-245">Direct Routing does not support Delayed Offer Invite (Invite without SDP).</span></span>

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a><span data-ttu-id="90c5b-246">Varios puntos de conexión que suenan con respuesta provisional</span><span class="sxs-lookup"><span data-stu-id="90c5b-246">Multiple endpoints ringing with provisional answer</span></span>

1.  <span data-ttu-id="90c5b-247">Al recibir la primera invitación desde el SBC, el proxy SIP envía el mensaje "SIP SIP/2.0 100 Trying" y notifica a todos los extremos del usuario final sobre la llamada entrante.</span><span class="sxs-lookup"><span data-stu-id="90c5b-247">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="90c5b-248">Tras la notificación, cada punto de conexión empezará a sonar y a enviar mensajes de "Progreso de llamada" al proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-248">Upon notification, each endpoint will start ringing and sending "Call progress” messages to the SIP proxy.</span></span> <span data-ttu-id="90c5b-249">Como un usuario de Teams puede tener varios puntos finales, el proxy SIP puede recibir varios mensajes de progreso de llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-249">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="90c5b-250">Por cada mensaje de progreso de llamada recibido de los clientes, el proxy SIP convierte el mensaje de progreso de llamada en el mensaje SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="90c5b-250">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span> <span data-ttu-id="90c5b-251">El intervalo para enviar estos mensajes se define por el intervalo de los mensajes de recepción desde el controlador de llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-251">The interval for sending such messages is defined by the interval of the receiving messages from the Call Controller.</span></span> <span data-ttu-id="90c5b-252">En el siguiente diagrama, hay dos 180 mensajes generados por el proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-252">In the following diagram, there are two 180 messages generated by the SIP proxy.</span></span> <span data-ttu-id="90c5b-253">Estos mensajes proceden de los dos puntos de conexión de Teams del usuario.</span><span class="sxs-lookup"><span data-stu-id="90c5b-253">These messages come from the two Teams endpoints of the user.</span></span> <span data-ttu-id="90c5b-254">Cada uno de los clientes tiene un id. de etiqueta único.</span><span class="sxs-lookup"><span data-stu-id="90c5b-254">The clients each have a unique Tag ID.</span></span>  <span data-ttu-id="90c5b-255">Cada mensaje procedente de un punto de conexión diferente será una sesión independiente (el parámetro "etiqueta" en el campo "Para" será diferente).</span><span class="sxs-lookup"><span data-stu-id="90c5b-255">Every message coming from a different endpoint will be a separate session (the parameter “tag” in the “To” field will be different).</span></span> <span data-ttu-id="90c5b-256">Sin embargo, es posible que un punto de conexión no genere el mensaje 180 y envíe el mensaje 183 inmediatamente, como se muestra en el siguiente diagrama.</span><span class="sxs-lookup"><span data-stu-id="90c5b-256">But an endpoint might not generate message 180 and send message 183 right away as shown in the following diagram.</span></span>

4.  <span data-ttu-id="90c5b-257">Una vez que un punto de conexión genera un mensaje de respuesta multimedia con las direcciones IP de los candidatos multimedia del punto de conexión, el proxy SIP convierte el mensaje recibido en un mensaje "Progreso de sesión SIP 183" con el SDP del cliente reemplazado por el SDP desde el procesador multimedia.</span><span class="sxs-lookup"><span data-stu-id="90c5b-257">Once an endpoint generates a Media Answer message with the IP addresses of endpoint’s media candidates, the SIP proxy converts the message received to a "SIP 183 Session Progress" message with the SDP from the client replaced by the SDP from the Media Processor.</span></span> <span data-ttu-id="90c5b-258">En el siguiente diagrama, el punto de conexión de Bifurcación 2 respondió a la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-258">In the following diagram, the endpoint from Fork 2 answered the call.</span></span> <span data-ttu-id="90c5b-259">Si el tronco no se omite, el mensaje SIP 183 solo se genera una vez (anillo bot o punto final del cliente).</span><span class="sxs-lookup"><span data-stu-id="90c5b-259">If the trunk is non-bypassed, the 183 SIP message is generated only once (either Ring Bot or Client End Point).</span></span> <span data-ttu-id="90c5b-260">El 183 puede venir en una bifurcación existente o iniciar una nueva.</span><span class="sxs-lookup"><span data-stu-id="90c5b-260">The 183 might come on an existing fork or start a new one.</span></span>

5.  <span data-ttu-id="90c5b-261">Se envía un mensaje de aceptación de llamadas con los candidatos finales del punto de conexión que aceptaron la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-261">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="90c5b-262">El mensaje Aceptación de llamadas se convierte en mensaje SIP 200.</span><span class="sxs-lookup"><span data-stu-id="90c5b-262">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="90c5b-263">![Diagrama que muestra varios puntos de conexión que suenan con respuesta provisional](media/direct-routing-protocols-1.png)</span><span class="sxs-lookup"><span data-stu-id="90c5b-263">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-1.png)</span></span>

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a><span data-ttu-id="90c5b-264">Varios puntos de conexión que suenan sin respuesta provisional</span><span class="sxs-lookup"><span data-stu-id="90c5b-264">Multiple endpoints ringing without provisional answer</span></span>

1.  <span data-ttu-id="90c5b-265">Al recibir la primera invitación desde el SBC, el proxy SIP envía el mensaje "SIP SIP/2.0 100 Trying" y notifica a todos los extremos del usuario final sobre la llamada entrante.</span><span class="sxs-lookup"><span data-stu-id="90c5b-265">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="90c5b-266">Tras la notificación, cada punto de conexión empezará a sonar y a enviar el mensaje "Progreso de la llamada" al proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-266">Upon notification, each endpoint will start ringing and sending the message "Call progress” to the SIP proxy.</span></span> <span data-ttu-id="90c5b-267">Como un usuario de Teams puede tener varios puntos finales, el proxy SIP puede recibir varios mensajes de progreso de llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-267">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="90c5b-268">Por cada mensaje de progreso de llamada recibido de los clientes, el proxy SIP convierte el mensaje de progreso de llamada en el mensaje SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="90c5b-268">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span>  <span data-ttu-id="90c5b-269">El intervalo para enviar los mensajes se define por el intervalo de recepción de los mensajes desde el controlador de llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-269">The interval for sending the messages is defined by the interval of receiving the messages from the Call Controller.</span></span> <span data-ttu-id="90c5b-270">En la imagen siguiente hay dos 180 mensajes generados por el proxy SIP, lo que significa que el usuario ha iniciado sesión en tres clientes de Teams y cada cliente envía el progreso de la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-270">On the picture below there are two 180 messages generated by the SIP proxy, meaning that user logged into three Teams clients and each client send the call progress.</span></span> <span data-ttu-id="90c5b-271">Cada mensaje será una sesión independiente (el parámetro "etiqueta" en el campo "Para" es diferente)</span><span class="sxs-lookup"><span data-stu-id="90c5b-271">Every message will be a separate session (parameter “tag” in “To” field is different)</span></span>

4.  <span data-ttu-id="90c5b-272">Se envía un mensaje de aceptación de llamadas con los candidatos finales del punto de conexión que aceptaron la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-272">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="90c5b-273">El mensaje Aceptación de llamadas se convierte en mensaje SIP 200.</span><span class="sxs-lookup"><span data-stu-id="90c5b-273">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="90c5b-274">![Diagrama que muestra varios puntos de conexión que suenan sin respuesta provisional](media/direct-routing-protocols-2.png)</span><span class="sxs-lookup"><span data-stu-id="90c5b-274">![Diagram showing multiple endpoints ringing without provisional answer](media/direct-routing-protocols-2.png)</span></span>

### <a name="media-bypass-flow"></a><span data-ttu-id="90c5b-275">Flujo de omisión de medios</span><span class="sxs-lookup"><span data-stu-id="90c5b-275">Media bypass flow</span></span>

<span data-ttu-id="90c5b-276">Los mismos mensajes (100 Intentando, 180, 183) se usan en el escenario de omisión de medios.</span><span class="sxs-lookup"><span data-stu-id="90c5b-276">The same messages (100 Trying, 180, 183) are used in the media bypass scenario.</span></span> 

<span data-ttu-id="90c5b-277">En el esquema siguiente se muestra un ejemplo del flujo de llamadas de omisión.</span><span class="sxs-lookup"><span data-stu-id="90c5b-277">The schema below shows an example of the bypass call flow.</span></span> 

> [!NOTE]
> <span data-ttu-id="90c5b-278">Los candidatos multimedia pueden venir de distintos puntos de conexión.</span><span class="sxs-lookup"><span data-stu-id="90c5b-278">The media candidates can come from different endpoints.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="90c5b-279">![Diagrama que muestra varios puntos de conexión que suenan con respuesta provisional](media/direct-routing-protocols-3.png)</span><span class="sxs-lookup"><span data-stu-id="90c5b-279">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-3.png)</span></span>

## <a name="replaces-option"></a><span data-ttu-id="90c5b-280">Opción Reemplazar</span><span class="sxs-lookup"><span data-stu-id="90c5b-280">Replaces option</span></span>

<span data-ttu-id="90c5b-281">El SBC debe admitir Invitar con reemplazos.</span><span class="sxs-lookup"><span data-stu-id="90c5b-281">The SBC must support Invite with Replaces.</span></span>

## <a name="size-of-sdp-considerations"></a><span data-ttu-id="90c5b-282">Tamaño de las consideraciones de SDP</span><span class="sxs-lookup"><span data-stu-id="90c5b-282">Size of SDP considerations</span></span>

<span data-ttu-id="90c5b-283">La interfaz de enrutamiento directo puede enviar un mensaje SIP que supere los 1.500 bytes.</span><span class="sxs-lookup"><span data-stu-id="90c5b-283">The Direct Routing interface might send a SIP message exceeding 1,500 bytes.</span></span>  <span data-ttu-id="90c5b-284">El tamaño de SDP causa principalmente esto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-284">The size of SDP primarily causes this.</span></span> <span data-ttu-id="90c5b-285">Sin embargo, si hay un tronco UDP detrás del SBC, puede rechazar el mensaje si se reenvía desde el proxy SIP de Microsoft al tronco sin modificar.</span><span class="sxs-lookup"><span data-stu-id="90c5b-285">However, if there is a UDP trunk behind the SBC, it might reject the message if it is forwarded from the Microsoft SIP proxy to the trunk unmodified.</span></span> <span data-ttu-id="90c5b-286">Microsoft recomienda quitar algunos valores de SDP en el SBC al enviar el mensaje a los troncos UDP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-286">Microsoft recommends stripping some values in SDP on the SBC when sending the message to the UDP trunks.</span></span> <span data-ttu-id="90c5b-287">Por ejemplo, los candidatos del ICE o los códecs sin usar se pueden quitar.</span><span class="sxs-lookup"><span data-stu-id="90c5b-287">For example, the ICE candidates or unused codecs can be removed.</span></span>

## <a name="call-transfer"></a><span data-ttu-id="90c5b-288">Transferencia de llamadas</span><span class="sxs-lookup"><span data-stu-id="90c5b-288">Call transfer</span></span>

<span data-ttu-id="90c5b-289">Enrutamiento directo admite dos métodos para la transferencia de llamadas:</span><span class="sxs-lookup"><span data-stu-id="90c5b-289">Direct Routing supports two methods for call transfer:</span></span>

- <span data-ttu-id="90c5b-290">Opción 1.</span><span class="sxs-lookup"><span data-stu-id="90c5b-290">Option 1.</span></span> <span data-ttu-id="90c5b-291">Procesos de proxy SIP Refiérase del cliente localmente y actúa como árbitro como se describe en la sección 7.1 de RFC 3892.</span><span class="sxs-lookup"><span data-stu-id="90c5b-291">SIP proxy processes Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span></span>

  <span data-ttu-id="90c5b-292">Con esta opción, el proxy SIP finaliza la transferencia y agrega una nueva invitación.</span><span class="sxs-lookup"><span data-stu-id="90c5b-292">With this option, the SIP proxy terminates the transfer and adds a new Invite.</span></span> 


- <span data-ttu-id="90c5b-293">Opción 2.</span><span class="sxs-lookup"><span data-stu-id="90c5b-293">Option 2.</span></span> <span data-ttu-id="90c5b-294">El proxy SIP envía la referencia al SBC y actúa como transferor como se describe en la sección 6 de RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="90c5b-294">SIP proxy sends the Refer to the SBC and acts as a Transferor as describing in Section 6 of RFC 5589.</span></span>

  <span data-ttu-id="90c5b-295">Con esta opción, el proxy SIP envía una referencia al SBC y espera que el SBC controle la transferencia por completo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-295">With this option, the SIP proxy sends a Refer to the SBC and expects the SBC to handle the Transfer fully.</span></span>

<span data-ttu-id="90c5b-296">El proxy SIP selecciona el método en función de las capacidades notificadas por el SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-296">The SIP proxy selects the method based on the capabilities reported by the SBC.</span></span> <span data-ttu-id="90c5b-297">Si el SBC indica que admite el método "Referencia", el proxy SIP usará la opción 2 para las transferencias de llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-297">If the SBC indicates that it supports the method “Refer”, the SIP proxy will use Option 2 for call transfers.</span></span>

<span data-ttu-id="90c5b-298">A continuación se muestra un ejemplo de un SBC que envía el mensaje de que el método Refer es compatible:</span><span class="sxs-lookup"><span data-stu-id="90c5b-298">The following is an example of an SBC sending the message that the Refer method is supported:</span></span>

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

<span data-ttu-id="90c5b-299">Si el SBC no indica que Hacer referencia como un método compatible, enrutamiento directo usará la opción 1 (proxy SIP actúa como árbitro).</span><span class="sxs-lookup"><span data-stu-id="90c5b-299">If the SBC doesn’t indicate that Refer as a supported method, Direct Routing will use Option 1 (SIP proxy acts as a Referee) .</span></span> <span data-ttu-id="90c5b-300">El SBC también debe indicar que es compatible con el método Notify:</span><span class="sxs-lookup"><span data-stu-id="90c5b-300">The SBC  must also signal that it supports the Notify method:</span></span>

<span data-ttu-id="90c5b-301">Ejemplo de SBC que indica que no se admite el método Refer:</span><span class="sxs-lookup"><span data-stu-id="90c5b-301">Example of SBC indicating that Refer method is not supported:</span></span>

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a><span data-ttu-id="90c5b-302">Procesos de proxy SIP Refiérase del cliente localmente y actúa como árbitro</span><span class="sxs-lookup"><span data-stu-id="90c5b-302">SIP proxy processes Refer from the client locally and acts as a Referee</span></span>

<span data-ttu-id="90c5b-303">Si el SBC indicaba que el método Refer no es compatible, el proxy SIP actúa como árbitro.</span><span class="sxs-lookup"><span data-stu-id="90c5b-303">If the SBC indicated that the Refer method is not supported, the SIP proxy acts as a Referee.</span></span> 

<span data-ttu-id="90c5b-304">La solicitud de referencia que proviene del cliente se finalizará en el proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-304">The Refer request that comes from the client will be terminated on the SIP proxy.</span></span> <span data-ttu-id="90c5b-305">(La solicitud De referencia del cliente se muestra como "Transferencia de llamadas a Dave" en el siguiente diagrama.</span><span class="sxs-lookup"><span data-stu-id="90c5b-305">(The Refer request from the client is shown as “Call transfer to Dave” in the following diagram.</span></span>  <span data-ttu-id="90c5b-306">Para obtener más información, vea la sección 7.1 de [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span><span class="sxs-lookup"><span data-stu-id="90c5b-306">For more information, see section 7.1 of [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="90c5b-307">![Diagrama que muestra varios puntos de conexión que suenan con respuesta provisional](media/direct-routing-protocols-4.png)</span><span class="sxs-lookup"><span data-stu-id="90c5b-307">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-4.png)</span></span>

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a><span data-ttu-id="90c5b-308">El proxy SIP envía la referencia al SBC y actúa como transferor</span><span class="sxs-lookup"><span data-stu-id="90c5b-308">SIP proxy send the Refer to the SBC and acts as a Transferor</span></span>

<span data-ttu-id="90c5b-309">Este es el método preferido para las transferencias de llamadas y es obligatorio para los dispositivos que buscan la certificación de omisión de medios.</span><span class="sxs-lookup"><span data-stu-id="90c5b-309">This is the preferred method for call transfers, and it is mandatory for devices seeking media bypass certification.</span></span> <span data-ttu-id="90c5b-310">La transferencia de llamadas sin que el SBC pueda controlar La referencia no es compatible con el modo de omisión de medios.</span><span class="sxs-lookup"><span data-stu-id="90c5b-310">Call Transfer without the SBC being able to handle Refer is not supported in media bypass mode.</span></span> 

<span data-ttu-id="90c5b-311">El estándar se explica en la sección 6 de RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="90c5b-311">The standard is explained in Section 6 of RFC 5589.</span></span> <span data-ttu-id="90c5b-312">Las RFC relacionadas son:</span><span class="sxs-lookup"><span data-stu-id="90c5b-312">The related RFCs are:</span></span>

- [<span data-ttu-id="90c5b-313">Control de llamadas del Protocolo de inicio de sesión (SIP): transferencia</span><span class="sxs-lookup"><span data-stu-id="90c5b-313">Session Initiation Protocol (SIP) Call Control - Transfer</span></span>](https://tools.ietf.org/html/rfc5589)

- [<span data-ttu-id="90c5b-314">Encabezado "Reemplaza" del Protocolo de inicio de sesión (SIP)</span><span class="sxs-lookup"><span data-stu-id="90c5b-314">Session Initiation Protocol (SIP) "Replaces" Header</span></span>](https://tools.ietf.org/html/rfc3891)

- [<span data-ttu-id="90c5b-315">Mecanismo de protocolo de inicio de sesión (SIP) "Referido por".</span><span class="sxs-lookup"><span data-stu-id="90c5b-315">Session Initiation Protocol (SIP) "Referred-By" mechanism</span></span>](https://tools.ietf.org/html/rfc3892)

<span data-ttu-id="90c5b-316">Esta opción supone que el proxy SIP actúa como transferor y envía un mensaje De referencia al SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-316">This option assumes that the SIP proxy acts as a Transferor and sends a Refer message to the SBC.</span></span> <span data-ttu-id="90c5b-317">El SBC actúa como transferible y controla la referencia para generar una nueva oferta de transferencia.</span><span class="sxs-lookup"><span data-stu-id="90c5b-317">The SBC acts as a Transferee and handles the Refer to generate a new offer for transfer.</span></span> <span data-ttu-id="90c5b-318">Hay dos casos posibles:</span><span class="sxs-lookup"><span data-stu-id="90c5b-318">There are two possible cases:</span></span>

- <span data-ttu-id="90c5b-319">La llamada se transfiere a un participante RTC externo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-319">The call is transferred to an external PSTN participant.</span></span> 
- <span data-ttu-id="90c5b-320">La llamada se transfiere de un usuario de Teams a otro usuario de Teams en el mismo espacio empresarial a través del SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-320">The call is transferred from one Teams user to another Teams user in the same tenant via the SBC.</span></span> 

<span data-ttu-id="90c5b-321">Si la llamada se transfiere de un usuario de Teams a otro a través del SBC, se espera que el SBC emita una nueva invitación (iniciar un nuevo cuadro de diálogo) para el destino de transferencia (el usuario de Teams) con la información recibida en el mensaje Referencia.</span><span class="sxs-lookup"><span data-stu-id="90c5b-321">If the call is transferred from one Teams user to another via the SBC, the SBC is expected to issue a new invite (start a new dialog) for the transfer target (the Teams user) using the information received in the Refer message.</span></span> 

<span data-ttu-id="90c5b-322">Para rellenar los campos Para/Transferir para la transacción de la solicitud internamente, el proxy SIP debe transmitir esta información dentro de los encabezados REFER-TO/REFERRED-BY.</span><span class="sxs-lookup"><span data-stu-id="90c5b-322">To populate the To/Transferor fields for the transaction of the request internally, the SIP proxy needs to convey this information  inside the REFER-TO/REFERRED-BY headers.</span></span> 

<span data-ttu-id="90c5b-323">El proxy SIP formará el URI REFER-TO como SIP compuesto de un FQDN de proxy SIP en el nombre de host y uno de los siguientes:</span><span class="sxs-lookup"><span data-stu-id="90c5b-323">The SIP proxy will form the REFER-TO as a SIP URI comprised of a SIP proxy FQDN in the hostname and either one of the following:</span></span>

- <span data-ttu-id="90c5b-324">Un número de teléfono E.164 en la parte de nombre de usuario del URI en caso de que el destino de la transferencia sea un número de teléfono o</span><span class="sxs-lookup"><span data-stu-id="90c5b-324">An E.164 phone number in the username part of the URI in case the transfer target is a phone number, or</span></span>

- <span data-ttu-id="90c5b-325">parámetros x-m y x-t que codifican la MRI de destino de transferencia completa y el id. de inquilino respectivamente</span><span class="sxs-lookup"><span data-stu-id="90c5b-325">x-m and x-t parameters encoding the full transfer target MRI and tenant ID respectively</span></span> 

<span data-ttu-id="90c5b-326">El encabezado REFERRED-BY es un URI SIP con MRI transferor codificado en él, así como id. de inquilino de transferor y otros parámetros de contexto de transferencia como se muestra en la tabla siguiente:</span><span class="sxs-lookup"><span data-stu-id="90c5b-326">The REFERRED-BY header is a SIP URI with transferor MRI encoded in it as well as transferor tenant ID and other transfer context parameters as shown in the following table:</span></span>

| <span data-ttu-id="90c5b-327">Parámetro</span><span class="sxs-lookup"><span data-stu-id="90c5b-327">Parameter</span></span> | <span data-ttu-id="90c5b-328">Valor</span><span class="sxs-lookup"><span data-stu-id="90c5b-328">Value</span></span> | <span data-ttu-id="90c5b-329">Descripción</span><span class="sxs-lookup"><span data-stu-id="90c5b-329">Description</span></span> |  
|:---------------------  |:---------------------- |:---------------------- |
| <span data-ttu-id="90c5b-330">x-m</span><span class="sxs-lookup"><span data-stu-id="90c5b-330">x-m</span></span> | <span data-ttu-id="90c5b-331">MRI</span><span class="sxs-lookup"><span data-stu-id="90c5b-331">MRI</span></span> | <span data-ttu-id="90c5b-332">MRI completa del destino de transferencia o transferencia rellenada por CC</span><span class="sxs-lookup"><span data-stu-id="90c5b-332">Full MRI of transferor/transfer target as populated by CC</span></span> |
| <span data-ttu-id="90c5b-333">x-t</span><span class="sxs-lookup"><span data-stu-id="90c5b-333">x-t</span></span> | <span data-ttu-id="90c5b-334">ID. del espacio empresarial</span><span class="sxs-lookup"><span data-stu-id="90c5b-334">Tenant ID</span></span> | <span data-ttu-id="90c5b-335">id. de inquilino opcional de x-t rellenado por CC</span><span class="sxs-lookup"><span data-stu-id="90c5b-335">x-t Tenant ID Optional Tenant ID as populated by CC</span></span> |
| <span data-ttu-id="90c5b-336">x-ti</span><span class="sxs-lookup"><span data-stu-id="90c5b-336">x-ti</span></span> | <span data-ttu-id="90c5b-337">Id. de correlación del transferor</span><span class="sxs-lookup"><span data-stu-id="90c5b-337">Transferor Correlation Id</span></span> | <span data-ttu-id="90c5b-338">Id. de correlación de la llamada al transferor</span><span class="sxs-lookup"><span data-stu-id="90c5b-338">Correlation ID of the call to the transferor</span></span> |
| <span data-ttu-id="90c5b-339">x-tt</span><span class="sxs-lookup"><span data-stu-id="90c5b-339">x-tt</span></span> | <span data-ttu-id="90c5b-340">Transferir uri de llamada de destino</span><span class="sxs-lookup"><span data-stu-id="90c5b-340">Transfer target call URI</span></span> | <span data-ttu-id="90c5b-341">URI de reemplazo de llamadas codificado</span><span class="sxs-lookup"><span data-stu-id="90c5b-341">Encoded call replacement URI</span></span> |

<span data-ttu-id="90c5b-342">En este caso, el tamaño del encabezado Referencia puede ser de hasta 400 símbolos.</span><span class="sxs-lookup"><span data-stu-id="90c5b-342">The size of the Refer Header can be up to 400 symbols in this case.</span></span> <span data-ttu-id="90c5b-343">El SBC debe admitir la administración de mensajes De referencia con un tamaño de hasta 400 símbolos.</span><span class="sxs-lookup"><span data-stu-id="90c5b-343">The SBC must support handling Refer messages with size up to 400 symbols.</span></span>

> [!div class="mx-imgBorder"]
> <span data-ttu-id="90c5b-344">![Diagrama que muestra varios puntos de conexión que suenan con respuesta provisional](media/direct-routing-protocols-5.png)</span><span class="sxs-lookup"><span data-stu-id="90c5b-344">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-5.png)</span></span>

## <a name="session-timer"></a><span data-ttu-id="90c5b-345">Temporizador de sesión</span><span class="sxs-lookup"><span data-stu-id="90c5b-345">Session timer</span></span>

<span data-ttu-id="90c5b-346">El proxy SIP admite (siempre ofrece) el temporizador de sesión en llamadas que no se omiten, pero no lo ofrece en llamadas de omisión.</span><span class="sxs-lookup"><span data-stu-id="90c5b-346">The SIP proxy supports (always offers) the Session Timer on non-bypass calls but does not offer it on bypass calls.</span></span> <span data-ttu-id="90c5b-347">El uso del temporizador de sesión por el SBC no es obligatorio.</span><span class="sxs-lookup"><span data-stu-id="90c5b-347">Use of the Session Timer by the SBC is not mandatory.</span></span>

##  <a name="use-of-request-uri-parameter-userphone"></a><span data-ttu-id="90c5b-348">Uso del parámetro Request-URI user=phone</span><span class="sxs-lookup"><span data-stu-id="90c5b-348">Use of Request-URI parameter user=phone</span></span>

<span data-ttu-id="90c5b-349">El proxy SIP analiza el URI de solicitud y, si el parámetro user=phone está presente, el servicio controlará el URI de solicitud como un número de teléfono, haciendo coincidir el número con un usuario.</span><span class="sxs-lookup"><span data-stu-id="90c5b-349">The SIP proxy analyses the Request-URI and if the parameter user=phone is present, the service will handle the Request-URI as a phone number, matching the number to a user.</span></span> <span data-ttu-id="90c5b-350">Si el parámetro no está presente, el proxy SIP aplica heurística para determinar el tipo de usuario De solicitud-URI (número de teléfono o dirección SIP).</span><span class="sxs-lookup"><span data-stu-id="90c5b-350">If parameter is not present the SIP proxy applies heuristics to determine  the Request-URI user type (phone number or a SIP address).</span></span>

<span data-ttu-id="90c5b-351">Microsoft recomienda aplicar siempre el parámetro user=phone para simplificar el proceso de configuración de la llamada.</span><span class="sxs-lookup"><span data-stu-id="90c5b-351">Microsoft recommends always applying the user=phone parameter to simplify the call setup process.</span></span>

## <a name="history-info-header"></a><span data-ttu-id="90c5b-352">History-Info encabezado</span><span class="sxs-lookup"><span data-stu-id="90c5b-352">History-Info header</span></span>

<span data-ttu-id="90c5b-353">El encabezado History-Info se usa para volver a dirigir solicitudes SIP y "proporcionar un mecanismo estándar para capturar la información del historial de solicitudes para habilitar una amplia variedad de servicios para redes y usuarios finales".</span><span class="sxs-lookup"><span data-stu-id="90c5b-353">The History-Info header is used for retargeting SIP requests and “provide(s) a standard mechanism for capturing the request history information to enable a wide variety of services for networks and end-users.”</span></span> <span data-ttu-id="90c5b-354">Para obtener más información, [vea RFC 4244 - Sección 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span><span class="sxs-lookup"><span data-stu-id="90c5b-354">For more information, see [RFC 4244 – Section 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span></span> <span data-ttu-id="90c5b-355">Para Microsoft Phone System, este encabezado se usa en escenarios de simulring y reenvío de llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-355">For Microsoft Phone System, this header is used in Simulring and Call Forwarding scenarios.</span></span>  

<span data-ttu-id="90c5b-356">Si envía, el History-Info está habilitado de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="90c5b-356">If sending, the History-Info is enabled as follows:</span></span>

- <span data-ttu-id="90c5b-357">El proxy SIP insertará un parámetro que contiene el número de teléfono asociado en entradas individuales History-Info que componen el encabezado de History-Info enviado al controlador RTC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-357">The SIP proxy will insert a parameter containing the associated phone number in individual History-Info entries that comprise the History-Info header sent to the PSTN Controller.</span></span>  <span data-ttu-id="90c5b-358">Con solo las entradas que tienen el parámetro de número de teléfono, el controlador RTC reconstruirá un nuevo encabezado de History-Info y lo pasará al proveedor de troncos SIP a través del proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-358">Using only entries that have the phone number parameter, the PSTN Controller will rebuild a new History-Info header, and pass it on to the SIP trunk provider via SIP proxy.</span></span>

- <span data-ttu-id="90c5b-359">History-Info encabezado se agregará para los casos de llamada y reenvío de llamadas simultáneas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-359">History-Info header will be added for simultaneous ring and call forwarding cases.</span></span>

- <span data-ttu-id="90c5b-360">History-Info encabezado no se agregará para los casos de transferencia de llamadas.</span><span class="sxs-lookup"><span data-stu-id="90c5b-360">History-Info header will not be added for call transfer cases.</span></span>

- <span data-ttu-id="90c5b-361">Una entrada de historial individual en el encabezado History-Info reconstruido tendrá el parámetro de número de teléfono proporcionado combinado con el FQDN de enrutamiento directo (sip.pstnhub.microsoft.com) establecido como la parte host del URI; se agregará un parámetro de "user=phone" como parte del URI de SIP.</span><span class="sxs-lookup"><span data-stu-id="90c5b-361">An individual history entry in the reconstructed History-Info header will have the phone number parameter provided combined with the Direct Routing FQDN (sip.pstnhub.microsoft.com) set as the host part of the URI; a parameter of ‘user=phone’ will be added as part of the SIP URI.</span></span>  <span data-ttu-id="90c5b-362">Cualquier otro parámetro asociado con el encabezado de History-Info original, excepto los parámetros de contexto del teléfono, se pasarán por el encabezado History-Info nuevo.</span><span class="sxs-lookup"><span data-stu-id="90c5b-362">Any other parameters associated with the original History-Info header, except for phone context parameters, will be passed through in the re-constructed History-Info header.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="90c5b-363">Las entradas que son privadas (según lo determinado por los mecanismos definidos en la sección 3.3 de RFC 4244) se reenviarán tal y como se debe a que el proveedor de troncos SIP es un punto de confianza.</span><span class="sxs-lookup"><span data-stu-id="90c5b-363">Entries that are private (as determined by the mechanisms defined in Section 3.3 of RFC 4244) will be forwarded as is because  the SIP trunk provider is a trusted peer.</span></span>

- <span data-ttu-id="90c5b-364">Las History-Info entrantes se pasan por alto.</span><span class="sxs-lookup"><span data-stu-id="90c5b-364">Inbound History-Info is ignored.</span></span>

<span data-ttu-id="90c5b-365">A continuación se muestra el formato del encabezado History-info enviado por el proxy SIP:</span><span class="sxs-lookup"><span data-stu-id="90c5b-365">Following is the format of the History-info header sent by the SIP proxy:</span></span>

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

<span data-ttu-id="90c5b-366">Si la llamada se redirija varias veces, la información sobre cada redirección se incluye con el motivo adecuado en orden cronológico.</span><span class="sxs-lookup"><span data-stu-id="90c5b-366">If the call was redirected several times, information about every redirect is included with the appropriate reason in chronological order.</span></span>


<span data-ttu-id="90c5b-367">Ejemplo de encabezado:</span><span class="sxs-lookup"><span data-stu-id="90c5b-367">Header Example:</span></span>

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

<span data-ttu-id="90c5b-368">El History-Info está protegido por un mecanismo TLS obligatorio.</span><span class="sxs-lookup"><span data-stu-id="90c5b-368">The History-Info is protected by a mandatory TLS mechanism.</span></span> 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a><span data-ttu-id="90c5b-369">Conexión SBC al mecanismo de enrutamiento directo y conmutación por error</span><span class="sxs-lookup"><span data-stu-id="90c5b-369">SBC connection to Direct Routing and failover mechanism</span></span>

<span data-ttu-id="90c5b-370">Vea la sección Mecanismo de conmutación por error para la señalización SIP en [Plan de enrutamiento directo.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)</span><span class="sxs-lookup"><span data-stu-id="90c5b-370">See the section Failover mechanism for SIP signaling in [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span></span>

## <a name="retry-after"></a><span data-ttu-id="90c5b-371">Retry-After</span><span class="sxs-lookup"><span data-stu-id="90c5b-371">Retry-After</span></span>

<span data-ttu-id="90c5b-372">Si un centro de datos de enrutamiento directo está ocupado, el servicio puede enviar un mensaje de Retry-After con un intervalo de un segundo al SBC.</span><span class="sxs-lookup"><span data-stu-id="90c5b-372">If a Direct Routing datacenter is busy, the service can send a Retry-After message with a one-second interval to the SBC.</span></span> <span data-ttu-id="90c5b-373">Cuando el SBC recibe un mensaje 503 con un encabezado Retry-After en respuesta a una INVITACIÓN, el SBC debe finalizar esa conexión y probar el siguiente centro de datos de Microsoft disponible.</span><span class="sxs-lookup"><span data-stu-id="90c5b-373">When the SBC receives a 503 message with a Retry-After header in response to an INVITE, the SBC must terminate that connection and try the next available Microsoft datacenter.</span></span>

## <a name="handling-retries-603-response"></a><span data-ttu-id="90c5b-374">Controlar los reintentos (respuesta 603)</span><span class="sxs-lookup"><span data-stu-id="90c5b-374">Handling retries (603 response)</span></span>
<span data-ttu-id="90c5b-375">Si un usuario final observa varias llamadas perdidas para una llamada después de rechazar la llamada entrante, significa que el mecanismo de reintentar del proveedor troncal SBC o RTC está mal configurado.</span><span class="sxs-lookup"><span data-stu-id="90c5b-375">If an end user observes several missed calls for one call after declining the incoming call, it means that the SBC or PSTN trunk provider's retry mechanism is misconfigured.</span></span> <span data-ttu-id="90c5b-376">Es necesario volver a configurar el SBC para detener los esfuerzos de reintentar la respuesta 603.</span><span class="sxs-lookup"><span data-stu-id="90c5b-376">The SBC must be reconfigured to stop the retry efforts on the 603 response.</span></span>

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a><span data-ttu-id="90c5b-377">Reinicio de ICE: llamada de omisión de medios transferida a un punto de conexión que no admite la omisión de medios</span><span class="sxs-lookup"><span data-stu-id="90c5b-377">ICE Restart: Media bypass call transferred to an endpoint that does not support media bypass</span></span>

<span data-ttu-id="90c5b-378">El SBC debe admitir los reinicios de ICE como se describe en [RFC 5245, sección 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span><span class="sxs-lookup"><span data-stu-id="90c5b-378">The SBC must support ICE restarts as described in [RFC 5245, section 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span></span>

<span data-ttu-id="90c5b-379">El reinicio en Enrutamiento directo se implementa según los párrafos siguientes de la RFC:</span><span class="sxs-lookup"><span data-stu-id="90c5b-379">The restart in Direct Routing is implemented according to the following paragraphs of the RFC:</span></span>

<span data-ttu-id="90c5b-380">*Para reiniciar ICE, un agente DEBE cambiar tanto el ice-pwd como el ice-ufrag para la transmisión multimedia en una oferta.  Tenga en cuenta que es permisible usar un atributo de nivel de sesión en una oferta, pero para proporcionar el mismo ice-pwd o ice-ufrag que un atributo de nivel multimedia en una oferta posterior.  Esto no es un cambio en la contraseña, solo un cambio en su representación y no causa un reinicio del ICE.*</span><span class="sxs-lookup"><span data-stu-id="90c5b-380">*To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.*</span></span>

<span data-ttu-id="90c5b-381">*Un agente establece el resto de los campos del SDP para esta transmisión multimedia como lo haría en una oferta inicial de esta transmisión multimedia (vea sección 4.3).  Por lo tanto, el conjunto de candidatos PUEDE incluir algunos, ninguno o todos los candidatos anteriores para esa transmisión y PUEDE incluir un conjunto totalmente nuevo de candidatos reunidos como se describe en la Sección 4.1.1.*</span><span class="sxs-lookup"><span data-stu-id="90c5b-381">*An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see Section 4.3).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates gathered as described in Section 4.1.1.*</span></span>

<span data-ttu-id="90c5b-382">Si la llamada se estableció inicialmente con omisión multimedia y la llamada se transfiere a un cliente de Skype Empresarial, enrutamiento directo debe insertar un procesador multimedia, esto se debe a que el enrutamiento directo no se puede usar con un cliente de Skype Empresarial con omisión de medios.</span><span class="sxs-lookup"><span data-stu-id="90c5b-382">If the call was initially established with media bypass, and the call is transferred to a Skype for Business client, Direct Routing needs to insert a Media Processor--this is because Direct Routing cannot be used with a Skype for Business client with media bypass.</span></span> <span data-ttu-id="90c5b-383">Enrutamiento directo inicia el proceso de reinicio del ICE cambiando el ice-pwd y ice-ufrag y ofreciendo nuevos candidatos a medios en un revite.</span><span class="sxs-lookup"><span data-stu-id="90c5b-383">Direct Routing starts the ICE restart process by  changing the ice-pwd and ice-ufrag and offering new media candidates in a reinvite.</span></span>
